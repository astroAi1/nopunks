const fs = require('fs');
const path = require('path');
const Jimp = require('jimp');

// Settings
const inputDir = '/Users/danriding/Desktop/nopunks2'; // Directory containing your PNG No-Punks
const outputFile = '/Users/danriding/Desktop/nopunks_grid_8x8.png'; // Final output file

const gridCols = 8;
const gridRows = 8;
const canvasSize = 2040; // Final canvas is 2040x2040

const createNoPunkGrid = async () => {
  // Get all PNG files from the input directory.
  const allFiles = fs.readdirSync(inputDir).filter(f => f.toLowerCase().endsWith('.png'));
  const totalImages = gridCols * gridRows; // 8x8 = 64

  if (allFiles.length < totalImages) {
    console.error(`Need at least ${totalImages} images, but only found ${allFiles.length}`);
    return;
  }

  // Shuffle the available file list and pick the first 64 images.
  const selected = allFiles.sort(() => 0.5 - Math.random()).slice(0, totalImages);

  // Calculate each cell's dimensions.
  const cellWidth = Math.floor(canvasSize / gridCols);
  const cellHeight = Math.floor(canvasSize / gridRows);

  // Create a blank 2040x2040 canvas with a black background.
  const grid = new Jimp(canvasSize, canvasSize, 0x000000FF);

  // Loop over each selected image and composite it into the correct cell.
  for (let i = 0; i < selected.length; i++) {
    const imgPath = path.join(inputDir, selected[i]);
    const img = await Jimp.read(imgPath);
    
    // Create a temporary cell canvas to ensure proper centering without stretching.
    const cell = new Jimp(cellWidth, cellHeight, 0x000000FF);
    
    // Use 'contain' so the image is scaled proportionally and centered.
    img.contain(cellWidth, cellHeight, Jimp.HORIZONTAL_ALIGN_CENTER | Jimp.VERTICAL_ALIGN_MIDDLE);
    cell.composite(img, 0, 0);
    
    // Compute the top left coordinates for this cell in the final grid.
    const x = (i % gridCols) * cellWidth;
    const y = Math.floor(i / gridCols) * cellHeight;
    
    grid.composite(cell, x, y);
  }

  // Save the final grid image as a PNG.
  await grid.writeAsync(outputFile);
  console.log(`âœ… Saved 8x8 No-Punks grid to: ${outputFile}`);
};

createNoPunkGrid().catch(err => console.error('Error:', err));